# EasyBet 赔率制彩票系统 - 使用指南

## 🎉 系统升级说明

系统已从**固定价格模式**升级为**赔率制对赌池模式**！

### ✨ 新特性

#### 旧系统（固定价格）
- ❌ 固定彩票价格
- ❌ 固定奖池
- ❌ 公证人需要提前投入资金
- ❌ 平均分配奖金

#### 新系统（赔率制对赌池）
- ✅ **任意金额投注** - 玩家可以自由选择投注金额
- ✅ **赔率锁定** - 购买时锁定赔率，后续调整不影响已购彩票
- ✅ **对赌池机制** - 所有投注进入对赌池，赢家瓜分输家的钱
- ✅ **比例分配** - 对赌池不足时按比例分配
- ✅ **公证人无需投入** - 创建活动时不需要提供初始资金

---

## 📋 合约地址

部署在 Ganache (Chain ID: 1337)：

```
BetToken:      0x0e0b89E2C0e57aa14f654032E077b9481EEc001F
EasyBet:       0xbbb9271e37374781a5466fe98f49E4fF4a27310B
LotteryTicket: 0x02fd4536FeEe857E5E8dF0fD271Cb205a2C7025e
```

---

## 🚀 快速开始

### 1. 确保 Ganache 正在运行
- 打开 Ganache GUI
- 确认 RPC Server: `http://127.0.0.1:8545`
- 确认 Network ID: `1337`

### 2. 配置 MetaMask
- 添加网络：
  - 网络名称: Ganache Local
  - RPC URL: http://127.0.0.1:8545
  - Chain ID: 1337
  - 货币符号: ETH

### 3. 导入 Ganache 账户
- 从 Ganache GUI 复制账户私钥
- 在 MetaMask 中导入账户

### 4. 启动前端
```bash
cd frontend
npm run dev
```

访问 http://localhost:3000

---

## 💡 使用教程

### 第一步：领取 BET Token

1. 连接 MetaMask 钱包
2. 点击 **"领取1000 BET Token"** 按钮
3. 确认交易
4. 24小时后可再次领取

### 第二步：创建竞猜活动（公证人）

填写表单：
- **活动名称**: 例如 "世界杯决赛"
- **选项**: 例如 "阿根廷,法国" （逗号分隔）
- **赔率**: 例如 "1.5,2.0" （逗号分隔，必须与选项数量一致）
- **持续时间**: 例如 1（小时）

点击 **"创建活动"**

#### 赔率说明
- 赔率表示倍数
- `1.5` = 1.5倍 = 投注100 BET，获胜得150 BET
- `2.0` = 2.0倍 = 投注100 BET，获胜得200 BET
- 最低赔率：1.0倍（100）

### 第三步：购买彩票

1. 在活动列表中选择一个活动
2. 每个选项会显示其赔率
3. 点击选项下的 **"投注"** 按钮
4. 输入投注金额（任意金额，例如 50）
5. 确认两次交易：
   - Approve（授权）
   - BuyTicket（购买）

### 第四步：查看我的彩票

在 **"🎫 我的彩票"** 区域可以看到：
- 彩票ID
- 投注金额
- **锁定赔率**（购买时的赔率，永不改变）
- **潜在收益**（投注金额 × 锁定赔率）

### 第五步：二级市场交易（可选）

#### 卖出彩票
1. 在"我的彩票"中点击 **"挂单出售"**
2. 输入出售价格
3. 确认交易（Approve + CreateOrder）

#### 买入彩票
1. 点击活动的 **"查看订单簿"**
2. 在订单列表中点击 **"购买"**
3. 确认交易

### 第六步：结算活动（公证人）

活动截止后：
1. 在活动卡片中选择获胜选项
2. 点击 **"结算"** 按钮
3. 确认交易

系统会自动：
- 计算所有赢家的总应付金额
- 如果对赌池足够：全额支付
- 如果对赌池不足：按比例分配
- 剩余资金退还公证人

---

## 🎮 完整示例

### 示例：足球比赛竞猜

**1. 创建活动**
```
活动名称: 曼联 vs 曼城
选项: 曼联胜,平局,曼城胜
赔率: 2.5,3.0,1.8
持续时间: 2
```

**2. 玩家投注**
- 玩家A: 100 BET → 曼联胜（锁定赔率2.5x）
- 玩家B: 200 BET → 曼城胜（锁定赔率1.8x）
- 玩家C: 50 BET → 曼联胜（锁定赔率2.5x）
- 玩家D: 150 BET → 曼城胜（锁定赔率1.8x）

**对赌池总计**: 500 BET

**3. 结算（假设曼联获胜）**

赢家彩票：
- 玩家A: 100 BET × 2.5 = 250 BET（应得）
- 玩家C: 50 BET × 2.5 = 125 BET（应得）
- 总应付: 375 BET

对赌池: 500 BET（足够）

实际支付：
- 玩家A: 250 BET ✅
- 玩家C: 125 BET ✅
- 公证人退款: 500 - 375 = 125 BET

**如果对赌池不足的情况**：

假设对赌池只有 300 BET，总应付 375 BET：
- 玩家A: 250 × (300/375) = 200 BET
- 玩家C: 125 × (300/375) = 100 BET

---

## 🔍 技术细节

### 赔率表示

系统内部使用**基点（basis points）**表示赔率：
- 用户输入: `1.5`
- 存储值: `150`
- 计算公式: `赔率 = 存储值 / 100`

### 结算算法

```solidity
// 第一轮：计算总应付
totalPayout = Σ(彩票金额 × 锁定赔率 / 100)

// 第二轮：分发
if (totalPayout <= totalPool) {
    // 全额支付
    每张彩票 = 彩票金额 × 锁定赔率 / 100
    剩余 = totalPool - totalPayout → 退还公证人
} else {
    // 按比例分配
    每张彩票 = (彩票金额 × 锁定赔率 / 100) × (totalPool / totalPayout)
}
```

### 订单簿交易

- 彩票转让时**保留原始投注金额和锁定赔率**
- 新持有者继承所有彩票属性
- 获胜时按锁定赔率计算收益

---

## 📊 与旧系统对比

| 特性 | 旧系统 | 新系统 |
|------|--------|--------|
| 彩票价格 | 固定 | 任意金额 |
| 奖池来源 | 公证人提供 | 玩家投注汇总 |
| 赔率 | 无 | 每个选项独立赔率 |
| 收益计算 | 平均分配 | 投注额 × 赔率 |
| 风险控制 | 无 | 自动比例分配 |
| 公证人成本 | 需要提前投入 | 无需投入 |

---

## 🧪 测试用例

已通过8个完整测试：
- ✅ 创建带赔率的活动
- ✅ 验证赔率参数（数量匹配、最小值）
- ✅ 任意金额购买彩票
- ✅ 多人不同金额投注
- ✅ 对赌池足够时全额支付
- ✅ 对赌池不足时按比例分配
- ✅ 订单簿交易保留原始赔率
- ✅ 彩票信息完整性

运行测试：
```bash
cd contracts
npx hardhat test test/testOddsSystem.ts
```

---

## ⚠️ 注意事项

1. **赔率一经锁定不可更改**
   - 购买彩票时锁定当前赔率
   - 即使公证人后续调整赔率，已购彩票不受影响

2. **对赌池可能不足**
   - 如果所有人都买赢的一方，对赌池会不够
   - 系统会自动按比例分配
   - 不会损失本金，但收益会减少

3. **公证人职责**
   - 设置合理的赔率
   - 准时结算
   - 确保活动公平性

4. **Gas费用**
   - 每次操作需要支付少量ETH作为gas
   - Ganache测试网络gas费极低

---

## 🎯 最佳实践

### 对于公证人
1. 设置合理赔率，避免所有人买一方
2. 高赔率 = 低概率，低赔率 = 高概率
3. 及时结算，维护信誉

### 对于玩家
1. 理解赔率含义
2. 分散投注，降低风险
3. 关注对赌池余额
4. 利用订单簿套利

### 风险管理
- 不要all-in单一选项
- 对赌池不足时可能无法全额获利
- 锁定赔率后无法更改

---

## 🔧 故障排查

### 问题：无法连接MetaMask
**解决**：确保MetaMask已添加Ganache网络（Chain ID: 1337）

### 问题：交易失败
**解决**：
1. 确认Ganache正在运行
2. 检查BET余额是否足够
3. 检查是否已approve

### 问题：无法领取BET
**解决**：等待24小时冷却期

### 问题：合约调用失败
**解决**：
1. 检查合约地址是否正确
2. 确认网络连接（Chain ID: 1337）
3. 查看浏览器控制台错误信息

---

## 📞 获取帮助

- 查看调试信息：展开页面上的 "🔍 调试信息"
- 打开诊断工具：在浏览器中打开 `diagnose.html`
- 查看合约代码：`contracts/contracts/`
- 查看测试用例：`contracts/test/testOddsSystem.ts`

---

## 🎓 学习资源

- Solidity 官方文档: https://docs.soliditylang.org/
- OpenZeppelin 合约库: https://docs.openzeppelin.com/
- Ethers.js 文档: https://docs.ethers.org/
- Hardhat 文档: https://hardhat.org/docs

---

**祝你使用愉快！🎲✨**
